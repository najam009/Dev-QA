- name: Deploy to EC2
  uses: appleboy/ssh-action@v0.1.7
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.EC2_KEY }}
    script: |
      AWS_REGION=${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPOSITORY=devqa
      IMAGE_TAG=${IMAGE_TAG}

      # Fail fast if IMAGE_TAG is empty
      if [ -z "$IMAGE_TAG" ]; then
        echo "‚ùå IMAGE_TAG is empty. Deployment aborted."
        exit 1
      fi

      IMAGE_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
      CONTAINER_NAME=myapp_$IMAGE_TAG

      echo "üöÄ Deploying $IMAGE_URI"

      # Login to ECR
      aws ecr get-login-password --region $AWS_REGION | \
        sudo docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com || {
          echo "‚ùå ECR login failed"; exit 1;
        }

      # Pull latest image
      sudo docker pull $IMAGE_URI || { echo "‚ùå Pull failed ‚Äî check ECR repo and tag"; exit 1; }

      # Stop old container if exists
      sudo docker stop $CONTAINER_NAME || true
      sudo docker rm $CONTAINER_NAME || true

      # Create temporary .env file
      TEMP_ENV=$(mktemp)
      echo "${{ secrets.ENV }}" > "$TEMP_ENV"

      # Run new container
      sudo docker run -d \
        --name $CONTAINER_NAME \
        --network host \
        --env-file "$TEMP_ENV" \
        -v /home/najam/S3bucket:/home/najam/S3bucket \
        $IMAGE_URI || { echo "‚ùå Docker run failed"; exit 1; }

      rm -f "$TEMP_ENV"
      echo "‚úÖ Successfully deployed $CONTAINER_NAME"
      echo "Currently running containers:"
      sudo docker ps
