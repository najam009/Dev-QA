name: CI/CD to EC2 via Docker & ECR

on:
  push:
    branches:
      - dev
      - qa

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_KEY }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  build-and-deploy:
    name: Build and Deploy on EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create private key file
        run: |
          echo "${{ secrets.EC2_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Build and push Docker image on EC2
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        run: |
          echo "Connecting to EC2 and building Docker image..."

          # Determine branch and port
          BRANCH_NAME=${GITHUB_REF##*/}
          if [ "$BRANCH_NAME" == "dev" ]; then
            PORT=3000
          else
            PORT=3001
          fi

          # SSH into EC2, build Docker image using Dockerfile on EC2, push to ECR
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            set -e
            echo "Logged into EC2 successfully."

            cd /home/ec2-user/dev-qa

            echo "Logging into ECR..."
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | sudo docker login --username AWS --password-stdin 633458675961.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

            echo "Building Docker image for branch: $BRANCH_NAME on port: $PORT"
            sudo docker build --build-arg APP_PORT=$PORT -t 633458675961.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:$BRANCH_NAME .

            echo "Pushing image to ECR..."
            sudo docker push 633458675961.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:$BRANCH_NAME

            echo "Stopping old container if exists..."
            sudo docker stop ${{ secrets.ECR_REPOSITORY }}-$BRANCH_NAME || true
            sudo docker rm ${{ secrets.ECR_REPOSITORY }}-$BRANCH_NAME || true

            echo "Running new container on port $PORT..."
            sudo docker run -d -p $PORT:$PORT --name ${{ secrets.ECR_REPOSITORY }}-$BRANCH_NAME 633458675961.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:$BRANCH_NAME

            echo "âœ… Deployment complete for branch: $BRANCH_NAME"
          EOF

  promote-to-qa:
    name: Promote Dev to QA
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/dev'

    steps:
      - name: Trigger QA branch deployment
        uses: peter-evans/workflow-dispatch@v2
        with:
          workflow: CI/CD to EC2 via Docker & ECR
          ref: qa
